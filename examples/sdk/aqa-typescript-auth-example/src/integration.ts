const STUDIO_DOCUMENT = `{"selectedLayoutId":"0","sdkVersion":"1.7.4","engineVersion":"1.4.1-main-","documentVersion":"0.4.0","properties":{"type":"template"},"pages":[{"id":"0","number":0,"frames":[{"id":"7","name":"water","type":"image","src":{"id":"a53c3da0-3d0e-4c4b-84a0-9089b39ce59b","type":"variable"},"blendMode":"normal","constrainProportions":false},{"id":"6","name":"bottle","type":"image","src":{"id":"a0998bec-ab34-4906-af8f-133d874bb1f8","type":"variable"},"blendMode":"normal","constrainProportions":false},{"id":"5","name":"logo","type":"image","src":{"id":"e50e2581-b048-4be0-964c-8e0a1e765fe5","assetId":"6a8b3947-2e17-4835-b052-a9d144517f31","type":"connector"},"blendMode":"normal","constrainProportions":false},{"id":"4","name":"splash","type":"image","src":{"id":"e50e2581-b048-4be0-964c-8e0a1e765fe5","assetId":"e3ea4440-7617-4b56-ab3b-cdd9616cbcf9","type":"connector"},"blendMode":"normal","constrainProportions":false},{"id":"3","name":"discover","type":"text","constrainProportions":false,"textContent":[{"type":"paragraph","paragraphStyleId":"eaf62a41-f9f0-4b7b-85f3-dc98786ba45f"},{"type":"span","style":{"fontKey":"grafx-fonts::81c28b10-cb23-4105-91a6-2a0dd0795817::8cd615a7-6bd9-49b8-b343-60e138f14dda"}},{"text":"DISCOVER","type":"text"}],"paddingLeft":0,"paddingTop":0,"paddingRight":0,"paddingBottom":0,"numberOfColumns":1,"columnGap":5000,"textDirection":"leftToRight","flowDirection":"horizontal","verticalAlign":"top","textStroke":false,"textStrokeWeight":1000,"textStrokeColor":0,"hasClippingPath":false,"blendMode":"normal"},{"id":"2","name":"regular","type":"text","constrainProportions":false,"textContent":[{"type":"paragraph"},{"type":"span"}],"paddingLeft":0,"paddingTop":0,"paddingRight":0,"paddingBottom":0,"numberOfColumns":1,"columnGap":5000,"textDirection":"leftToRight","flowDirection":"horizontal","verticalAlign":"top","textStroke":false,"textStrokeWeight":1000,"textStrokeColor":0,"hasClippingPath":false,"blendMode":"normal"},{"id":"1","name":"button","type":"image","blendMode":"normal","constrainProportions":false}]}],"layouts":[{"id":"0","name":"Rectangle","frameProperties":[{"id":"1","x":182000,"y":160000,"width":117000,"height":40000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false},{"id":"2","x":165000,"y":114000,"width":150000,"height":60000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false},{"id":"3","x":165000,"y":90000,"width":150000,"height":60000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false},{"id":"4","x":8000,"y":112000,"width":150000,"height":111000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","crop":{"type":"noCrop"},"type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false},{"id":"5","x":203000,"y":25000,"width":75000,"height":43000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","crop":{"type":"noCrop"},"type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false},{"id":"6","x":0,"y":19000,"width":176000,"height":227000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","crop":{"type":"noCrop"},"type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false},{"id":"7","x":-27000,"y":99000,"width":383000,"height":209000,"rotationDegrees":0,"rotationOriginY":0,"scaleX":1,"scaleY":1,"isVisible":true,"fitMode":"fill","crop":{"type":"noCrop"},"type":"top","minCopyfitting":0.1,"maxCopyfitting":10,"enableCopyfitting":false}],"width":336000,"height":280000,"childLayouts":["1","2"],"type":"top","frameAnimations":[{"id":"1","from":2000,"to":5000,"basicAnimations":{"intro":{"from":0,"to":1000,"ease":"noEase","styles":{"fade":true}},"emphasis":{"from":1500,"to":2500,"ease":"noEase","styles":{"flash":true}}}},{"id":"2","from":500,"to":5000,"basicAnimations":{"intro":{"from":0,"to":500,"ease":"noEase","styles":{"slide":{"direction":"left","offsetPercent":100},"fade":true}}}},{"id":"3","from":0,"to":5000,"basicAnimations":{"intro":{"from":0,"to":500,"ease":"noEase","styles":{"slide":{"direction":"left","offsetPercent":100},"fade":true}}}},{"id":"4","from":0,"to":5000,"basicAnimations":{}},{"id":"5","from":0,"to":5000,"basicAnimations":{}},{"id":"6","from":0,"to":5000,"basicAnimations":{}},{"id":"7","from":0,"to":5000,"basicAnimations":{}}],"timelineLengthMs":5000,"unit":"px","intent":"digitalAnimated","fillColor":{"color":{"r":255,"g":255,"b":255,"type":"rgb"},"opacity":1,"type":"local"}},{"id":"1","name":"Skyscraper","parentId":"0","frameProperties":[{"id":"1","x":22000,"y":216000,"type":"child"},{"id":"2","x":5000,"y":160000,"isVisible":true,"type":"child"},{"id":"3","x":5000,"y":136000,"isVisible":true,"type":"child"},{"id":"4","x":1000,"y":353000,"isVisible":true,"type":"child"},{"id":"5","x":43000,"y":56000,"isVisible":true,"type":"child"},{"id":"6","x":-8000,"y":260000,"isVisible":true,"type":"child"},{"id":"7","x":-333000,"y":281000,"width":593000,"height":352000,"isVisible":true,"type":"child"}],"width":160000,"height":600000,"childLayouts":[],"type":"child"},{"id":"2","name":"Leaderboard","parentId":"0","frameProperties":[{"id":"1","x":350000,"y":22000,"type":"child"},{"id":"2","x":156000,"y":44000,"isVisible":true,"type":"child"},{"id":"3","x":156000,"y":20000,"isVisible":true,"type":"child"},{"id":"4","isVisible":false,"type":"child"},{"id":"5","x":44000,"y":23000,"isVisible":true,"type":"child"},{"id":"6","x":474000,"y":-15000,"width":102000,"height":146000,"isVisible":true,"type":"child"},{"id":"7","x":-75000,"y":-5000,"width":845000,"height":160000,"isVisible":true,"type":"child"}],"width":728000,"height":90000,"childLayouts":[],"type":"child"}],"stylekit":{"colors":[{"id":"967d7caa-3b18-405e-9931-6d38189d83ea","name":"black","color":{"r":20,"g":20,"b":20,"type":"rgb"}}],"characterStyles":[],"paragraphStyles":[{"id":"eaf62a41-f9f0-4b7b-85f3-dc98786ba45f","name":"Paragraph Style 1","fontKey":"grafx-fonts::a65481ce-3217-4e94-9e99-211c42698a19::b68ecea2-d580-45a6-a962-f70e4d40aec7","fontSize":22,"typographicCase":"normal","kerningOn":false,"subSuperScript":"normal","trackingLeft":0,"trackingRight":0,"indentStart":0,"indentEnd":0,"spaceBefore":0,"spaceAfter":0,"textIndent":0,"alignToBaseLine":false,"baselineShiftValue":0,"lineHeight":120,"textAlign":"center","textAlignLast":"left","textOverprint":false,"color":{"color":{"r":0,"g":0,"b":0,"type":"rgb"},"type":"local"},"fillColorApplied":true,"underline":false,"lineThrough":false}],"fontFamilies":[{"id":"grafx-fonts::81c28b10-cb23-4105-91a6-2a0dd0795817","name":"Avenir","connectorId":"grafx-fonts","fontFamilyId":"81c28b10-cb23-4105-91a6-2a0dd0795817","fontStyles":[{"id":"grafx-fonts::81c28b10-cb23-4105-91a6-2a0dd0795817::273c3a56-92cd-4771-b4f9-6b037f4da61f","fontStyleId":"273c3a56-92cd-4771-b4f9-6b037f4da61f","fontFamilyId":"81c28b10-cb23-4105-91a6-2a0dd0795817","connectorId":"grafx-fonts","name":"Regular 400","isDefault":false},{"id":"grafx-fonts::81c28b10-cb23-4105-91a6-2a0dd0795817::8cd615a7-6bd9-49b8-b343-60e138f14dda","fontStyleId":"8cd615a7-6bd9-49b8-b343-60e138f14dda","fontFamilyId":"81c28b10-cb23-4105-91a6-2a0dd0795817","connectorId":"grafx-fonts","name":"Extra Bold 800","isDefault":false}]},{"id":"grafx-fonts::6a07101f-ce52-476c-be5c-662250906acb","name":"Abbieshire","connectorId":"grafx-fonts","fontFamilyId":"6a07101f-ce52-476c-be5c-662250906acb","fontStyles":[{"id":"grafx-fonts::6a07101f-ce52-476c-be5c-662250906acb::93d338a0-68b6-42d9-b7bb-df28b2dd8362","fontStyleId":"93d338a0-68b6-42d9-b7bb-df28b2dd8362","fontFamilyId":"6a07101f-ce52-476c-be5c-662250906acb","connectorId":"grafx-fonts","name":"Regular 400","isDefault":false}]},{"id":"grafx-fonts::a65481ce-3217-4e94-9e99-211c42698a19","name":"Chili Pepper Dingbats","connectorId":"grafx-fonts","fontFamilyId":"a65481ce-3217-4e94-9e99-211c42698a19","fontStyles":[{"id":"grafx-fonts::a65481ce-3217-4e94-9e99-211c42698a19::b89727ed-67ff-41a2-b8db-f4d18b699816","fontStyleId":"b89727ed-67ff-41a2-b8db-f4d18b699816","fontFamilyId":"a65481ce-3217-4e94-9e99-211c42698a19","connectorId":"grafx-fonts","name":"Light 300 Italic","isDefault":false}]}]},"variables":[{"id":"a53c3da0-3d0e-4c4b-84a0-9089b39ce59b","type":"image","parentId":"","name":"water","label":"Variable 1","isVisible":true,"isReadonly":false,"isRequired":false,"value":{"connectorId":"51fdde21-8875-4a07-8b86-3023aace4b71","assetId":"ece95b5a-28d9-4645-9529-bd6f968a7d3d"}},{"id":"a0998bec-ab34-4906-af8f-133d874bb1f8","type":"image","parentId":"","name":"bottle","label":"Variable 2","isVisible":true,"isReadonly":false,"isRequired":false,"value":{"connectorId":"33b56e7a-0e27-4596-a66e-b1bfd81963c5","assetId":"4610c24b-fb44-4842-a34f-5a1115de6211"}},{"id":"44c63426-43a1-4340-a5a4-0f14cbf45331","type":"image","parentId":"","name":"dam","label":"Variable 3","isVisible":true,"isReadonly":false,"isRequired":false,"value":{"connectorId":"d7944766-abc0-48e5-8b1d-6b061a96eeee","assetId":""}},{"id":"d5f7a4e6-82f6-4708-a780-eadde2610424","type":"shortText","parentId":"","name":"text","label":"Variable 4","isVisible":true,"isReadonly":false,"isRequired":false,"value":"REGULAR!"},{"id":"c524a390-8937-4319-ab77-7c7cc9f6db01","type":"shortText","parentId":"","name":"visible","label":"Variable 5","isVisible":true,"isReadonly":false,"isRequired":false,"value":""},{"id":"5491d225-9a44-4889-a40f-983eadf858e1","type":"list","parentId":"","name":"list","label":"Variable 6","isVisible":true,"isReadonly":false,"isRequired":false,"items":[{"value":"Apple"},{"value":"Pear"},{"value":"Orange"}]}],"connectors":[{"id":"grafx-media","name":"GraFx Media","source":{"source":"local","url":"grafx-media.json"},"options":{},"mappings":[]},{"id":"grafx-fonts","name":"GraFx Fonts","source":{"source":"local","url":"grafx-fonts.json"},"options":{},"mappings":[]},{"id":"51fdde21-8875-4a07-8b86-3023aace4b71","name":"GraFx Media","source":{"url":"https://cp-xyg-380.cpstaging.online/grafx/api/experimental/environment/cp-xyg-380/connectors/76c73fee-3abb-4ef9-a6df-0c3c4cc3e8ee","source":"grafx"},"options":{},"mappings":[]},{"id":"33b56e7a-0e27-4596-a66e-b1bfd81963c5","name":"GraFx Media","source":{"url":"https://cp-xyg-380.cpstaging.online/grafx/api/experimental/environment/cp-xyg-380/connectors/76c73fee-3abb-4ef9-a6df-0c3c4cc3e8ee","source":"grafx"},"options":{},"mappings":[]},{"id":"e50e2581-b048-4be0-964c-8e0a1e765fe5","name":"GraFx Media","source":{"url":"https://cp-xyg-380.cpstaging.online/grafx/api/experimental/environment/cp-xyg-380/connectors/76c73fee-3abb-4ef9-a6df-0c3c4cc3e8ee","source":"grafx"},"options":{},"mappings":[]},{"id":"d7944766-abc0-48e5-8b1d-6b061a96eeee","name":"GraFx Media","source":{"url":"https://cp-xyg-380.cpstaging.online/grafx/api/experimental/environment/cp-xyg-380/connectors/76c73fee-3abb-4ef9-a6df-0c3c4cc3e8ee","source":"grafx"},"options":{},"mappings":[]}],"actions":[]}`;

declare global {
  interface Window {
    SDK: any;
  }
}

const executeSDK = async (accessToken: string) => {
  // Initialise SDK
  //@ts-ignore
  const SDK = new StudioSDK.default({
    editorId: "chili-editor-example",
  });

  window.SDK = SDK;
  const zoomToPage = async () => {
    const zoomParams: {
      pageId: null;
      left: number;
      top: number;
      width: number;
      height: number;
    } = {
      pageId: null,
      left: 0,
      top: 0,
      width: Math.floor(
        document.getElementsByTagName("iframe")?.[0]?.getBoundingClientRect()
          .width
      ),
      height: Math.floor(
        document.getElementsByTagName("iframe")?.[0]?.getBoundingClientRect()
          .height
      ),
    };

    await SDK.canvas.zoomToPage(
      zoomParams.pageId,
      zoomParams.left,
      zoomParams.top,
      zoomParams.width,
      zoomParams.height
    );
  };

  SDK.loadEditor();
  await SDK.configuration.setValue("GRAFX_AUTH_TOKEN", accessToken);
  await SDK.configuration.setValue(
    "ENVIRONMENT_API",
    "https://cp-xyg-380.cpstaging.online/grafx/api/v1/environment/cp-xyg-380"
  );

  // Load document
  const loadDocument = async () => {
    await SDK.document.load(STUDIO_DOCUMENT);
    zoomToPage();
  };
  loadDocument();
};

const loadScript = async (url: string, callback: () => void) => {
  return new Promise((resolve, reject) => {
    if (url) {
      try {
        const scriptTag = window.document.createElement("script");
        scriptTag.src = url;
        // Set up onload event
        scriptTag.onload = () => {
          resolve(scriptTag);
          callback(); // Call the callback function
        };
        window.document.body.appendChild(scriptTag);
      } catch (e) {
        console.error("Error loading script:", e);
      }
    }
  });
};

const init = async (accessToken: string, pr: string) => {
  let url = "";
  if (pr !== "") {
    url = `https://stgrafxstudiodevpublic.blob.core.windows.net/sdk/dev-packages/${pr}/dist/browser/main.js`;
  } else {
    url =
      "https://stgrafxstudiodevpublic.blob.core.windows.net/sdk/latest/main.js";
  }

  loadScript(url, () => {
    executeSDK(accessToken);
  });
};

export default {
  init,
};
